<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidSearch â€” Tests QualitÃ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.7/purify.min.js"
            integrity="sha256-QM/0krVDU6Vc35/7NpeGU5/7fVTSX5fdSh6JdbMJw10="
            crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #f8f9fa;
            color: #202124;
        }
        h1 { color: #1a73e8; margin-bottom: 4px; }
        .subtitle { color: #5f6368; margin-bottom: 24px; font-size: 14px; }

        /* Barre de rÃ©sumÃ© */
        #summary {
            display: flex;
            gap: 16px;
            padding: 16px 20px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #dadce0;
            margin-bottom: 24px;
            font-weight: 500;
        }
        #summary .total  { color: #202124; }
        #summary .passed { color: #1e8e3e; }
        #summary .failed { color: #d93025; }
        #summary .skipped { color: #f29900; }
        #progress {
            height: 4px;
            background: #dadce0;
            border-radius: 2px;
            margin-bottom: 24px;
            overflow: hidden;
        }
        #progress-bar { height: 100%; background: #1e8e3e; width: 0; transition: width 0.3s; }

        /* Suites */
        .suite {
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .suite-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 15px;
            background: #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .suite-header:hover { background: #e8eaed; }
        .suite-badge {
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .badge-ok  { background: #d4edda; color: #155724; }
        .badge-err { background: #f8d7da; color: #721c24; }
        .suite-body { display: block; }
        .suite-body.collapsed { display: none; }

        /* Tests individuels */
        .test-case {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 16px;
            border-top: 1px solid #f1f3f4;
            font-size: 14px;
        }
        .test-case:first-child { border-top: none; }
        .test-icon { flex-shrink: 0; font-size: 16px; line-height: 1.4; }
        .test-name { flex: 1; line-height: 1.4; }
        .test-detail {
            margin-top: 4px;
            font-size: 12px;
            color: #5f6368;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        .test-case.fail .test-detail { color: #d93025; }
        .test-time { flex-shrink: 0; font-size: 12px; color: #80868b; align-self: center; }
    </style>
</head>
<body>
    <h1>ğŸ§ª KidSearch â€” Tests QualitÃ©</h1>
    <p class="subtitle">Tests automatisÃ©s avec assertions â€” ouvrir dans un navigateur (python -m http.server 8000)</p>

    <div id="progress"><div id="progress-bar"></div></div>

    <div id="summary">
        <span class="total">â³ ExÃ©cutionâ€¦</span>
    </div>

    <div id="output"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mini test runner
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const runner = (() => {
    const suites = [];
    let currentSuite = null;
    let total = 0, passed = 0, failed = 0;

    function describe(name, fn) {
        currentSuite = { name, tests: [] };
        suites.push(currentSuite);
        fn();
    }

    function it(name, fn) {
        const test = { name, status: 'pending', detail: '', ms: 0 };
        currentSuite.tests.push(test);
        total++;
        try {
            const t0 = performance.now();
            fn();
            test.ms = Math.round(performance.now() - t0);
            test.status = 'pass';
            passed++;
        } catch (e) {
            test.status = 'fail';
            test.detail = e.message;
            failed++;
        }
    }

    function assert(condition, msg) {
        if (!condition) throw new Error(msg || 'Assertion Ã©chouÃ©e');
    }

    function assertEqual(a, b, msg) {
        if (a !== b) throw new Error(msg || `Attendu: ${JSON.stringify(b)}\nObtenu:  ${JSON.stringify(a)}`);
    }

    function assertIncludes(str, substr, msg) {
        if (!String(str).includes(substr))
            throw new Error(msg || `"${str}" ne contient pas "${substr}"`);
    }

    function assertNotIncludes(str, substr, msg) {
        if (String(str).includes(substr))
            throw new Error(msg || `"${str}" contient "${substr}" alors qu'il ne devrait pas`);
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';

        suites.forEach(suite => {
            const suitePass = suite.tests.every(t => t.status === 'pass');
            const suiteDiv = document.createElement('div');
            suiteDiv.className = 'suite';

            const header = document.createElement('div');
            header.className = 'suite-header';
            const failCount = suite.tests.filter(t => t.status === 'fail').length;
            const badge = suitePass
                ? `<span class="suite-badge badge-ok">âœ“ ${suite.tests.length} OK</span>`
                : `<span class="suite-badge badge-err">âœ— ${failCount} Ã©chec${failCount > 1 ? 's' : ''}</span>`;
            header.innerHTML = `<span>${suite.name}</span>${badge}`;

            const body = document.createElement('div');
            body.className = 'suite-body' + (suitePass ? ' collapsed' : '');
            header.addEventListener('click', () => body.classList.toggle('collapsed'));

            suite.tests.forEach(t => {
                const div = document.createElement('div');
                div.className = `test-case ${t.status === 'fail' ? 'fail' : ''}`;
                const icon = t.status === 'pass' ? 'âœ…' : 'âŒ';
                div.innerHTML = `
                    <span class="test-icon">${icon}</span>
                    <span class="test-name">
                        ${t.name}
                        ${t.detail ? `<div class="test-detail">${t.detail}</div>` : ''}
                    </span>
                    <span class="test-time">${t.ms}ms</span>
                `;
                body.appendChild(div);
            });

            suiteDiv.appendChild(header);
            suiteDiv.appendChild(body);
            out.appendChild(suiteDiv);
        });

        // RÃ©sumÃ©
        const pct = total > 0 ? Math.round(passed / total * 100) : 0;
        document.getElementById('progress-bar').style.width = pct + '%';
        document.getElementById('progress-bar').style.background = failed > 0 ? '#d93025' : '#1e8e3e';
        document.getElementById('summary').innerHTML = `
            <span class="total">Total : ${total}</span>
            <span class="passed">âœ“ ${passed} passÃ©s</span>
            ${failed > 0 ? `<span class="failed">âœ— ${failed} Ã©chouÃ©s</span>` : ''}
        `;
    }

    return { describe, it, assert, assertEqual, assertIncludes, assertNotIncludes, render };
})();

const { describe, it, assert, assertEqual, assertIncludes, assertNotIncludes } = runner;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fonctions copiÃ©es depuis knowledge-panels.js
// pour les tester en isolation (sans effets de bord)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeText(text) {
    return text.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

function stem(word) {
    return word
        .replace(/aux$/, 'al')       // avant /x$/ : animaux â†’ animal
        .replace(/eux$/, 'eu')       // avant /x$/ : cheveux â†’ cheveu
        .replace(/s$/, '')
        .replace(/x$/, '')
        .replace(/tion$/, '')
        .replace(/ment$/, '')
        .replace(/able$/, '')
        .replace(/ible$/, '');
}

function findBestMatch(query, searchResults) {
    if (!searchResults || searchResults.length === 0) return null;

    const queryNorm = normalizeText(query);
    if (!queryNorm) return null;
    const queryWords = queryNorm.split(' ').filter(w => w.length > 2);
    const queryStemmed = stem(queryNorm);

    const scored = searchResults.map(result => {
        const titleNorm = normalizeText(result.title);
        const titleStemmed = stem(titleNorm);
        const snippetNorm = normalizeText(result.snippet || '');
        let score = 0;

        if (titleNorm === queryNorm || titleStemmed === queryStemmed) score += 100;
        if (titleNorm.includes(queryNorm) || titleStemmed.includes(queryStemmed)) score += 50;
        if (titleNorm.startsWith(queryNorm) || titleStemmed.startsWith(queryStemmed)) score += 30;

        let wordsInTitle = 0;
        queryWords.forEach(word => {
            const wordStem = stem(word);
            if (titleNorm.includes(word) || titleStemmed.includes(wordStem)) wordsInTitle++;
        });
        score += wordsInTitle * 10;

        if (queryWords.length > 1 && wordsInTitle === queryWords.length) score += 25;
        if (titleNorm.length > queryNorm.length * 3) score -= 5;

        const wordsInSnippet = queryWords.filter(w => {
            const ws = stem(w);
            return snippetNorm.includes(w) || snippetNorm.includes(ws);
        }).length;
        score += wordsInSnippet * 2;

        return { result, score };
    });

    scored.sort((a, b) => b.score - a.score);
    const MINIMUM_SCORE = 15;
    if (scored[0].score < MINIMUM_SCORE) return null;
    return scored[0].result;
}

function detectQueryLanguage(query) {
    const lq = query.toLowerCase();
    if (/[Ã Ã¢Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã»Ã¹Ã¼Ã¿Å“Ã¦]/i.test(lq) || /\b(le|la|les|un|une|des)\b/i.test(lq)) return 'fr';
    if (/\b(the|and|for|what|who|are)\b/i.test(lq)) return 'en';
    return null;
}

// Logique de sanitization extraite de knowledge-panels.js (aprÃ¨s fix XSS)
function sanitizeForPanel(str) {
    if (typeof DOMPurify !== 'undefined') {
        return DOMPurify.sanitize(str || '', { ALLOWED_TAGS: [] });
    }
    return (str || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function isSafeUrl(u) {
    return typeof u === 'string' && /^https?:\/\//i.test(u);
}

// Logique de signature de cache extraite de search.js (aprÃ¨s fix)
function getConfigSignature(sources) {
    return sources
        .filter(s => s.enabled)
        .map(s => `${s.id}:${s.weight || 1}`)
        .join('|');
}

function getImageConfigSignature(sources) {
    return sources
        .filter(s => s.enabled && s.supportsImages)
        .map(s => `${s.id}:${s.weight || 1}`)
        .join('|');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 1 â€” Scoring findBestMatch
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('1 Â· findBestMatch() â€” Scoring et pertinence', () => {

    it('retourne null si rÃ©sultats vides', () => {
        assert(findBestMatch('dinosaures', []) === null);
    });

    it('retourne null si rÃ©sultats null', () => {
        assert(findBestMatch('dinosaures', null) === null);
    });

    it('accepte une correspondance exacte de titre', () => {
        const results = [{ title: 'Dinosaure', snippet: '' }];
        const match = findBestMatch('dinosaures', results);
        assert(match !== null, 'Devrait accepter "Dinosaure" pour "dinosaures"');
        assertEqual(match.title, 'Dinosaure');
    });

    it('accepte une correspondance de titre avec accents normalisÃ©s', () => {
        const results = [{ title: 'PhotosynthÃ¨se', snippet: '' }];
        const match = findBestMatch('photosynthÃ¨se', results);
        assert(match !== null);
        assertEqual(match.title, 'PhotosynthÃ¨se');
    });

    it('rejette "TempÃªte" pour la requÃªte "Dassault Rafale"', () => {
        const results = [
            { title: 'TempÃªte', snippet: 'Un phÃ©nomÃ¨ne mÃ©tÃ©orologique...' },
            { title: 'Avion de chasse', snippet: 'Un avion militaire...' },
        ];
        const match = findBestMatch('Dassault Rafale', results);
        assert(match === null, '"TempÃªte" ne devrait pas Ãªtre retournÃ© pour "Dassault Rafale"');
    });

    it('prÃ©fÃ¨re le titre le plus spÃ©cifique parmi plusieurs candidats', () => {
        const results = [
            { title: 'Guerre', snippet: 'Un conflit armÃ©...' },
            { title: 'Seconde Guerre mondiale', snippet: 'Conflit de 1939-1945...' },
        ];
        const match = findBestMatch('Seconde Guerre mondiale', results);
        assert(match !== null);
        assertEqual(match.title, 'Seconde Guerre mondiale');
    });

    it('accepte une correspondance exacte (Marie Curie)', () => {
        const results = [
            { title: 'Marie Curie', snippet: 'Physicienne et chimiste franÃ§aise...' },
            { title: 'Prix Nobel', snippet: 'RÃ©compense internationale...' },
        ];
        const match = findBestMatch('Marie Curie', results);
        assert(match !== null);
        assertEqual(match.title, 'Marie Curie');
    });

    it('prend en compte le snippet pour amÃ©liorer le score', () => {
        const weakTitle = [{ title: 'Volcans', snippet: 'Le volcan est une structure gÃ©ologique qui Ã©met de la lave' }];
        const match = findBestMatch('volcan', weakTitle);
        // "Volcans" correspond par stemming, snippet renforce
        assert(match !== null);
    });

    it('gÃ¨re une requÃªte sans mots longs : pas de bonus words, mais match exact possible', () => {
        // "le" â†’ queryWords vide (filtrÃ© par length > 2)
        // Mais le titre "Le" matche exactement â†’ score 100 â†’ panel retournÃ©
        const results = [{ title: 'Le', snippet: '' }];
        const match = findBestMatch('le', results);
        assert(match !== null, 'Match exact sur le titre mÃªme pour un mot court');
    });

    it('retourne null quand la requÃªte courte ne matche aucun titre', () => {
        // "go" ne correspond Ã  rien dans les titres â†’ score 0 < 15
        const results = [
            { title: 'Dinosaure', snippet: '' },
            { title: 'Volcan', snippet: '' },
        ];
        const match = findBestMatch('go', results);
        assert(match === null, 'Aucun titre ne correspond Ã  "go"');
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 2 â€” DÃ©tection de langue
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('2 Â· detectQueryLanguage() â€” DÃ©tection langue', () => {

    it('dÃ©tecte le franÃ§ais via les accents', () => {
        assertEqual(detectQueryLanguage('Ã©ruption volcanique'), 'fr');
    });

    it('dÃ©tecte le franÃ§ais via les articles', () => {
        assertEqual(detectQueryLanguage('les dinosaures'), 'fr');
    });

    it('dÃ©tecte le franÃ§ais via "un"', () => {
        assertEqual(detectQueryLanguage('un animal'), 'fr');
    });

    it('dÃ©tecte l\'anglais via "the"', () => {
        assertEqual(detectQueryLanguage('the dinosaur'), 'en');
    });

    it('dÃ©tecte l\'anglais via "what"', () => {
        assertEqual(detectQueryLanguage('what is gravity'), 'en');
    });

    it('retourne null pour un mot ambigu sans marqueurs', () => {
        assertEqual(detectQueryLanguage('Paris'), null);
    });

    it('retourne null pour une requÃªte numÃ©rique', () => {
        assertEqual(detectQueryLanguage('1944'), null);
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 3 â€” SÃ©curitÃ© : sanitization XSS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('3 Â· SÃ©curitÃ© â€” Sanitization XSS (DOMPurify)', () => {

    it('neutralise une balise <script> dans le titre', () => {
        const malicious = '<script>alert("xss")<\/script>Dinosaure';
        const safe = sanitizeForPanel(malicious);
        assertNotIncludes(safe, '<script>', 'La balise <script> doit Ãªtre supprimÃ©e');
        assertNotIncludes(safe, 'alert(', 'Le code JS doit Ãªtre supprimÃ©');
    });

    it('neutralise une balise <img onerror> dans le titre', () => {
        const malicious = '<img src=x onerror=alert(1)>Chat';
        const safe = sanitizeForPanel(malicious);
        assertNotIncludes(safe, 'onerror', 'onerror ne doit pas passer');
    });

    it('neutralise du HTML dans l\'extrait', () => {
        const malicious = '<b>gras</b><a href="evil">lien</a>texte';
        const safe = sanitizeForPanel(malicious);
        assertNotIncludes(safe, '<b>', 'Les balises HTML doivent Ãªtre supprimÃ©es');
        assertNotIncludes(safe, '<a ', 'Les liens HTML doivent Ãªtre supprimÃ©s');
        assertIncludes(safe, 'texte', 'Le texte utile doit Ãªtre conservÃ©');
    });

    it('conserve le texte brut sans l\'altÃ©rer', () => {
        const plain = 'Dinosaures : animaux prÃ©historiques';
        const safe = sanitizeForPanel(plain);
        assertEqual(safe, plain);
    });

    it('gÃ¨re une valeur null sans planter', () => {
        const safe = sanitizeForPanel(null);
        assertEqual(safe, '');
    });

    it('gÃ¨re une valeur undefined sans planter', () => {
        const safe = sanitizeForPanel(undefined);
        assertEqual(safe, '');
    });

    it('neutralise une injection via attribut style', () => {
        const malicious = '<p style="background:url(javascript:alert(1))">texte</p>';
        const safe = sanitizeForPanel(malicious);
        assertNotIncludes(safe, 'javascript:', 'javascript: ne doit pas passer dans style');
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 4 â€” SÃ©curitÃ© : validation des URLs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('4 Â· SÃ©curitÃ© â€” Validation des URLs', () => {

    it('accepte une URL https valide', () => {
        assert(isSafeUrl('https://fr.vikidia.org/wiki/Dinosaure'));
    });

    it('accepte une URL http valide', () => {
        assert(isSafeUrl('http://localhost:8000/results.html'));
    });

    it('rejette une URL javascript:', () => {
        assert(!isSafeUrl('javascript:alert(1)'));
    });

    it('rejette une URL data:', () => {
        assert(!isSafeUrl('data:text/html,<script>alert(1)<\/script>'));
    });

    it('rejette une chaÃ®ne vide', () => {
        assert(!isSafeUrl(''));
    });

    it('rejette null', () => {
        assert(!isSafeUrl(null));
    });

    it('rejette undefined', () => {
        assert(!isSafeUrl(undefined));
    });

    it('rejette un chemin relatif', () => {
        assert(!isSafeUrl('/wiki/Dinosaure'), 'Les chemins relatifs ne sont pas safe');
    });

    it('rejette une URL vbscript:', () => {
        assert(!isSafeUrl('vbscript:msgbox(1)'));
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 5 â€” Signature de cache
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('5 Â· Cache â€” Signatures uniques (search.js)', () => {

    const vikidiaOnly = [
        { id: 'vikidia', enabled: true, weight: 1.0, supportsImages: true },
    ];
    const wikiOnly = [
        { id: 'wikipedia', enabled: true, weight: 0.8, supportsImages: false },
    ];
    const both = [
        { id: 'vikidia',   enabled: true, weight: 1.0, supportsImages: true },
        { id: 'wikipedia', enabled: true, weight: 0.8, supportsImages: false },
    ];
    const bothDifferentWeight = [
        { id: 'vikidia',   enabled: true, weight: 0.5, supportsImages: true },
        { id: 'wikipedia', enabled: true, weight: 0.8, supportsImages: false },
    ];

    it('deux sources diffÃ©rentes â†’ signatures diffÃ©rentes', () => {
        const sig1 = getConfigSignature(vikidiaOnly);
        const sig2 = getConfigSignature(wikiOnly);
        assert(sig1 !== sig2, `"${sig1}" devrait â‰  "${sig2}"`);
    });

    it('mÃªme source â†’ mÃªme signature', () => {
        const sig1 = getConfigSignature(vikidiaOnly);
        const sig2 = getConfigSignature(vikidiaOnly);
        assertEqual(sig1, sig2);
    });

    it('un poids diffÃ©rent â†’ signature diffÃ©rente', () => {
        const sig1 = getConfigSignature(both);
        const sig2 = getConfigSignature(bothDifferentWeight);
        assert(sig1 !== sig2, 'Un changement de poids doit changer la signature');
    });

    it('source dÃ©sactivÃ©e â†’ exclue de la signature', () => {
        const withDisabled = [
            { id: 'vikidia',   enabled: true,  weight: 1.0, supportsImages: true },
            { id: 'wikipedia', enabled: false, weight: 0.8, supportsImages: false },
        ];
        const sig1 = getConfigSignature(vikidiaOnly);
        const sig2 = getConfigSignature(withDisabled);
        assertEqual(sig1, sig2, 'La source dÃ©sactivÃ©e ne doit pas modifier la signature');
    });

    it('signature image n\'inclut que les sources supportant les images', () => {
        const sigAll  = getImageConfigSignature(both);     // vikidia only (wikipedia: supportsImages false)
        const sigViki = getImageConfigSignature(vikidiaOnly);
        assertEqual(sigAll, sigViki, 'Wikipedia sans supportsImages ne doit pas figurer dans la signature image');
    });

    it('signature non vide pour au moins une source active', () => {
        const sig = getConfigSignature(vikidiaOnly);
        assert(sig.length > 0, 'La signature ne doit pas Ãªtre vide');
    });

    it('signature vide si toutes les sources sont dÃ©sactivÃ©es', () => {
        const allOff = [
            { id: 'vikidia',   enabled: false, weight: 1.0, supportsImages: true },
            { id: 'wikipedia', enabled: false, weight: 0.8, supportsImages: false },
        ];
        const sig = getConfigSignature(allOff);
        assertEqual(sig, '', 'Signature vide si aucune source active');
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 6 â€” Normalisation de texte (stemming)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('6 Â· Normalisation â€” Stemming franÃ§ais', () => {

    it('retire le "s" du pluriel', () => {
        assertIncludes(stem('dinosaures'), 'dinosaure');
    });

    it('retire le "x" du pluriel', () => {
        const s = stem('voix');
        assertNotIncludes(s, 'x');
    });

    it('normalise "animaux" â†’ "animal"', () => {
        assertEqual(stem('animaux'), 'animal');
    });

    it('normalise "cheveux" â†’ "cheveu"', () => {
        assertEqual(stem('cheveux'), 'cheveu');
    });

    it('normalise un mot en "-tion"', () => {
        const s = stem('revolution');
        assertNotIncludes(s, 'tion');
    });

    it('normalise un mot en "-ment"', () => {
        const s = stem('rapidement');
        assertNotIncludes(s, 'ment');
    });

    it('ne modifie pas un mot court sans suffixe', () => {
        assertEqual(stem('chat'), 'chat');
    });

    it('normalise les accents avec normalizeText', () => {
        const n = normalizeText('Ã‰ruption Volcanique');
        assertNotIncludes(n, 'Ã‰', 'Les accents doivent Ãªtre retirÃ©s');
        assertIncludes(n, 'eruption');
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUITE 7 â€” Cas limites et rÃ©gressions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
describe('7 Â· RÃ©gressions & cas limites', () => {

    it('findBestMatch : requÃªte vide ne plante pas', () => {
        const results = [{ title: 'Dinosaure', snippet: '' }];
        // La requÃªte vide â†’ queryWords vide â†’ score 0 < 15
        const match = findBestMatch('', results);
        assert(match === null, 'Une requÃªte vide ne doit rien retourner');
    });

    it('findBestMatch : un seul rÃ©sultat pertinent est retournÃ©', () => {
        const results = [{ title: 'Lune', snippet: 'Satellite naturel de la Terre' }];
        const match = findBestMatch('Lune', results);
        assert(match !== null);
        assertEqual(match.title, 'Lune');
    });

    it('sanitize : conserve les apostrophes et tirets', () => {
        const text = "L'encyclopÃ©die des 8-13 ans";
        const safe = sanitizeForPanel(text);
        assertIncludes(safe, "L'encyclopÃ©die");
        assertIncludes(safe, '8-13');
    });

    it('isSafeUrl : URL HTTPS en majuscules', () => {
        assert(isSafeUrl('HTTPS://example.com'), 'HTTPS majuscule doit Ãªtre acceptÃ©');
    });

    it('isSafeUrl : URL avec port et chemin complexe', () => {
        assert(isSafeUrl('https://fr.vikidia.org:443/wiki/Marie_Curie?lang=fr#section'));
    });

    it('signature de cache : ordre des sources compte', () => {
        const order1 = [
            { id: 'vikidia',   enabled: true, weight: 1.0 },
            { id: 'wikipedia', enabled: true, weight: 0.8 },
        ];
        const order2 = [
            { id: 'wikipedia', enabled: true, weight: 0.8 },
            { id: 'vikidia',   enabled: true, weight: 1.0 },
        ];
        // Les deux configs ont les mÃªmes sources mais dans un ordre diffÃ©rent
        // â†’ la signature doit reflÃ©ter cet ordre pour la reproductibilitÃ©
        const sig1 = getConfigSignature(order1);
        const sig2 = getConfigSignature(order2);
        assert(sig1 !== sig2, "L'ordre des sources doit Ãªtre reflÃ©tÃ© dans la signature");
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Lancement et rendu
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
runner.render();
</script>
</body>
</html>
